`
<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Anti-fraud Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
  <style>
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #020617;
      color: #e5e7eb;
    }
    .layout {
      padding: 16px;
      display: grid;
      grid-template-columns: repeat(12, 1fr);
      grid-gap: 16px;
    }
    .card {
      background: #020617;
      border-radius: 16px;
      padding: 12px 16px;
      box-shadow: 0 12px 30px rgba(0,0,0,0.5);
      border: 1px solid #1e293b;
    }
    .kpi { grid-column: span 3; }
    .kpi-title {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: #94a3b8;
    }
    .kpi-value {
      font-size: 24px;
      margin-top: 4px;
    }
    #chart-timeseries { grid-column: span 8; height: 320px; }
    #chart-score-hist { grid-column: span 4; height: 320px; }
    #chart-by-channel { grid-column: span 6; height: 260px; }
    #chart-by-country { grid-column: span 6; height: 260px; }
    #table-top { grid-column: span 12; }
    table { width: 100%; border-collapse: collapse; font-size: 12px; }
    th, td {
      padding: 6px 8px;
      border-bottom: 1px solid #1f2937;
    }
    th { text-align: left; color: #9ca3af; }
  </style>
</head>
<body>
<div class="layout">
  <!-- KPI -->
  <div class="card kpi">
    <div class="kpi-title">Всего транзакций</div>
    <div id="kpi-total" class="kpi-value">—</div>
  </div>
  <div class="card kpi">
    <div class="kpi-title">Флагнуто</div>
    <div id="kpi-flagged" class="kpi-value">—</div>
  </div>
  <div class="card kpi">
    <div class="kpi-title">Доля фрода</div>
    <div id="kpi-rate" class="kpi-value">—</div>
  </div>
  <div class="card kpi">
    <div class="kpi-title">Средний скор</div>
    <div id="kpi-avg" class="kpi-value">—</div>
  </div>

  <div id="chart-timeseries" class="card"></div>
  <div id="chart-score-hist" class="card"></div>
  <div id="chart-by-channel" class="card"></div>
  <div id="chart-by-country" class="card"></div>

  <div id="table-top" class="card">
    <div style="font-size: 14px; margin-bottom: 8px;">Топ подозрительных транзакций</div>
    <table>
      <thead>
        <tr>
          <th>Дата</th>
          <th>Txn</th>
          <th>Клиент</th>
          <th>Сумма</th>
          <th>Страна</th>
          <th>Канал</th>
          <th>Скор</th>
        </tr>
      </thead>
      <tbody id="top-body"></tbody>
    </table>
  </div>
</div>

<script>
async function fetchJSON(url) {
  const res = await fetch(url);
  if (!res.ok) throw new Error("HTTP " + res.status);
  return await res.json();
}

async function initDashboard() {
  // KPI
  const summary = await fetchJSON('/api/summary');
  const total = summary.total_tx;
  const flagged = summary.flagged_tx;
  const rate = total ? (flagged * 100 / total).toFixed(2) + '%' : '0%';

  document.getElementById('kpi-total').textContent = total;
  document.getElementById('kpi-flagged').textContent = flagged;
  document.getElementById('kpi-rate').textContent = rate;
  document.getElementById('kpi-avg').textContent = summary.avg_score.toFixed(3);

  // Timeseries
  const tsData = await fetchJSON('/api/timeseries');
  const tsChart = echarts.init(document.getElementById('chart-timeseries'));
  tsChart.setOption({
    backgroundColor: 'transparent',
    tooltip: { trigger: 'axis' },
    legend: { data: ['Всего', 'Флагнуто'], textStyle: { color: '#e5e7eb' } },
    grid: { left: 40, right: 20, top: 40, bottom: 40 },
    xAxis: {
      type: 'category',
      data: tsData.map(d => d.date),
      axisLine: { lineStyle: { color: '#64748b' } }
    },
    yAxis: {
      type: 'value',axisLine: { lineStyle: { color: '#64748b' } },
      splitLine: { lineStyle: { color: '#1f2937' } }
    },
    series: [
      { name: 'Всего', type: 'bar', data: tsData.map(d => d.total_tx) },
      { name: 'Флагнуто', type: 'line', data: tsData.map(d => d.flagged_tx), smooth: true }
    ]
  });

  // Histogram
  const hist = await fetchJSON('/api/score-histogram');
  const histChart = echarts.init(document.getElementById('chart-score-hist'));
  histChart.setOption({
    backgroundColor: 'transparent',
    tooltip: { trigger: 'axis' },
    grid: { left: 40, right: 20, top: 40, bottom: 40 },
    xAxis: {
      type: 'category',
      data: hist.map(d => d.bin),
      axisLine: { lineStyle: { color: '#64748b' } }
    },
    yAxis: {
      type: 'value',
      axisLine: { lineStyle: { color: '#64748b' } },
      splitLine: { lineStyle: { color: '#1f2937' } }
    },
    series: [{ type: 'bar', data: hist.map(d => d.cnt) }]
  });

  // By channel
  const byChannel = await fetchJSON('/api/by-channel');
  const chanChart = echarts.init(document.getElementById('chart-by-channel'));
  chanChart.setOption({
    backgroundColor: 'transparent',
    tooltip: { trigger: 'axis' },
    legend: { data: ['Всего', 'Флагнуто'], textStyle: { color: '#e5e7eb' } },
    grid: { left: 40, right: 20, top: 40, bottom: 40 },
    xAxis: {
      type: 'category',
      data: byChannel.map(d => d.channel),
      axisLine: { lineStyle: { color: '#64748b' } }
    },
    yAxis: {
      type: 'value',
      axisLine: { lineStyle: { color: '#64748b' } },
      splitLine: { lineStyle: { color: '#1f2937' } }
    },
    series: [
      { name: 'Всего', type: 'bar', data: byChannel.map(d => d.total_tx) },
      { name: 'Флагнуто', type: 'bar', data: byChannel.map(d => d.flagged_tx) }
    ]
  });

  const top = await fetchJSON('/api/top-transactions');
  const tbody = document.getElementById('top-body');
  tbody.innerHTML = top.map(row => 
    '<tr>' +
      '<td>' + row.event_date +'</td>' +
      '<td>' + row.transaction_id +'</td>' +
      '<td>' + row.customer_id +'</td>' +
      '<td>' + row.amount.toFixed(2) +'</td>' +
      '<td>' + row.country || '' +'</td>' +
      '<td>' + row.channel || '' +'</td>' +
      '<td>' + row.fraud_score.toFixed(3) +'</td>' +
    '</tr>'
  ).join('');
}

initDashboard().catch(err => {
  console.error(err);
});
</script>
</body>
</html>
`