<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Anti-fraud Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/echarts-gl@2/dist/echarts-gl.min.js"></script>
  <style>
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #020617;
      color: #e5e7eb;
    }
    .top-table-scroll {
      max-height: 260px;
      overflow-y: auto;
    }
    .layout {
      padding: 16px;
      display: grid;
      grid-template-columns: repeat(12, 1fr);
      grid-gap: 16px;
    }
    .card {
      background: #020617;
      border-radius: 16px;
      padding: 12px 16px;
      box-shadow: 0 12px 30px rgba(0,0,0,0.5);
      border: 1px solid #1e293b;
    }
    .kpi { grid-column: span 3; }
    .kpi-title {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: #94a3b8;
    }
    .kpi-value {
      font-size: 24px;
      margin-top: 4px;
    }
    #chart-timeseries { grid-column: span 8; height: 320px; }
    #chart-score-hist { grid-column: span 4; height: 320px; }
    #chart-by-channel { grid-column: span 6; height: 260px; }
    #chart-by-country { grid-column: span 6; height: 260px; }
    #table-top { grid-column: span 12; }
    table { width: 100%; border-collapse: collapse; font-size: 12px; }
    th, td {
      padding: 6px 8px;
      border-bottom: 1px solid #1f2937;
    }
    th { text-align: left; color: #9ca3af; }

    .txn-panel {
      display: grid;
      grid-template-columns: 360px 1fr;
      gap: 12px;
      height: 520px;
    }
    .txn-list {
      border: 1px solid #1f2937;
      border-radius: 12px;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }
    .txn-list-header {
      padding: 10px 12px;
      border-bottom: 1px solid #1f2937;
      color: #9ca3af;
      font-size: 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .txn-items {
      overflow: auto;
      flex: 1;
    }
    .txn-item {
      padding: 10px 12px;
      border-bottom: 1px solid #0b1220;
      cursor: pointer;
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 8px;
    }
    .txn-item:hover { background: rgba(37,99,235,0.12); }
    .txn-item.active { background: rgba(37,99,235,0.22); }
    .txn-item .sub {
      color: #94a3b8;
      font-size: 11px;
      margin-top: 2px;
    }
    .txn-item .score {
      font-variant-numeric: tabular-nums;
      color: #e5e7eb;
    }
  </style>
</head>
<body>
<div class="layout">
  <div class="card" style="grid-column: span 12; display:flex; gap:12px; align-items:center;">
    <span style="font-size: 13px; color:#9ca3af;">Период:</span>
    <input id="from-date" type="date" style="background:#020617;border:1px solid #1f2937;border-radius:8px;padding:4px 8px;color:#e5e7eb;">
    <span>—</span>
    <input id="to-date" type="date" style="background:#020617;border:1px solid #1f2937;border-radius:8px;padding:4px 8px;color:#e5e7eb;">
    <button id="apply-range" style="margin-left:8px;padding:4px 12px;border-radius:8px;border:none;background:#2563eb;color:white;cursor:pointer;">
      Применить
    </button>
  </div>
  <div class="card kpi">
    <div class="kpi-title">Всего транзакций</div>
    <div id="kpi-total" class="kpi-value">—</div>
  </div>
  <div class="card kpi">
    <div class="kpi-title">Флагнуто</div>
    <div id="kpi-flagged" class="kpi-value">—</div>
  </div>
  <div class="card kpi">
    <div class="kpi-title">Доля фрода</div>
    <div id="kpi-rate" class="kpi-value">—</div>
  </div>
  <div class="card kpi">
    <div class="kpi-title">Средний скор</div>
    <div id="kpi-avg" class="kpi-value">—</div>
  </div>

  <div id="chart-fraud-3d-cluster" class="card" style="grid-column: span 6; height: 520px;"></div>
  <div id="chart-fraud-3d" class="card" style="grid-column: span 6; height: 520px;"></div>
  <div id="chart-timeseries" class="card"></div>
  <div id="chart-score-hist" class="card"></div>
  <div id="chart-by-channel" class="card"></div>

  <div class="card" style="grid-column: span 12; padding: 12px 12px 12px 12px;">
    <div style="font-size: 14px; margin-bottom: 8px;">Фродовая транзакция и её связи</div>
    <div class="txn-panel">
      <div class="txn-list">
        <div class="txn-list-header">
          <span>Фродовые транзакции (выбор)</span>
          <button id="refresh-fraud-list" style="padding:4px 10px;border-radius:8px;border:1px solid #1f2937;background:#0b1220;color:#e5e7eb;cursor:pointer;">Обновить</button>
        </div>
        <div id="fraud-txn-items" class="txn-items"></div>
      </div>
      <div id="chart-txn-links" style="width:100%; height:100%;"></div>
    </div>
  </div>

  <div id="chart-links" class="card" style="grid-column: span 12; height: 520px;"></div>

  <div id="table-top" class="card">
    <div style="font-size: 14px; margin-bottom: 8px;">Топ подозрительных транзакций</div>
      <div class="top-table-scroll">
        <table>
          <thead>
            <tr>
              <th>Дата</th>
              <th>Txn</th>
              <th>Клиент</th>
              <th>Сумма</th>
              <th>Страна</th>
              <th>Канал</th>
              <th>Скор</th>
            </tr>
          </thead>
          <tbody id="top-body"></tbody>
        </table>
      </div>
  </div>
</div>
<script>
async function fetchJSON(url) {
  const res = await fetch(url);
  if (!res.ok) throw new Error("HTTP " + res.status);
  return await res.json();
}

function buildGraphOption(graph) {
  const categories = [
    { name: 'txn' }, { name: 'customer' }, { name: 'card' }, { name: 'device' }, { name: 'email' }
  ];
  const catIndex = (cat) => {
    if (cat === 'txn') return 0;
    if (cat === 'customer') return 1;
    if (cat === 'card') return 2;
    if (cat === 'device') return 3;
    if (cat === 'email') return 4;
    return 0;
  };

  return {
    backgroundColor: 'transparent',
    tooltip: { formatter: (p) => p.dataType === 'node' ? p.data.name : '' },
    legend: [{ data: categories.map(c => c.name), textStyle: { color: '#e5e7eb' } }],
    series: [{
      type: 'graph',
      layout: 'force',
      roam: true,
      draggable: true,
      categories,
      force: { repulsion: 140, edgeLength: 55, gravity: 0.05 },
      label: { show: false },
      emphasis: { focus: 'adjacency' },
      lineStyle: { opacity: 0.35, width: 1 },
      data: graph.nodes.map(n => ({
        name: n.id,
        category: catIndex(n.cat),
        symbolSize: n.cat === 'txn' ? (10 + Math.min(24, (n.value ?? 0) * 28)) : 12,
        value: n.value
      })),
      links: graph.edges.map(e => ({ source: e.source, target: e.target }))
    }]
  };
}

async function loadFraudTxnList(from, to) {
  const itemsEl = document.getElementById('fraud-txn-items');
  itemsEl.innerHTML = '<div style="padding:10px 12px;color:#94a3b8;">Загрузка…</div>';

  const rows = await fetchJSON(`/api/fraud-txns?from=${from}&to=${to}&limit=500`);
  if (!rows.length) {
    itemsEl.innerHTML = '<div style="padding:10px 12px;color:#94a3b8;">Нет фродовых транзакций в выбранном диапазоне</div>';
    return null;
  }

  itemsEl.innerHTML = rows.map((r, idx) => {
    const score = (r.fraud_score ?? 0).toFixed(3);
    const amt = (r.amount ?? 0).toFixed(2);
    return `
      <div class="txn-item" data-txn="${r.transaction_id}" data-idx="${idx}">
        <div>
          <div><b>${r.transaction_id}</b></div>
          <div class="sub">${r.event_date} · ${r.channel || 'UNKNOWN'} · ${amt}</div>
        </div>
        <div class="score">${score}</div>
      </div>
    `;
  }).join('');

  const nodes = itemsEl.querySelectorAll('.txn-item');
  nodes.forEach(n => {
    n.onclick = async () => {
      nodes.forEach(x => x.classList.remove('active'));
      n.classList.add('active');
      const txnId = n.getAttribute('data-txn');
      await renderTxnLinks(from, to, txnId);
    };
  });

  nodes[0].classList.add('active');
  return rows[0].transaction_id;
}

async function renderTxnLinks(from, to, txnId) {
  const el = document.getElementById('chart-txn-links');
  const chart = echarts.init(el);
  chart.showLoading('default', { text: 'Загрузка связей…', textColor: '#e5e7eb', maskColor: 'rgba(2,6,23,0.35)'});
  try {
    const graph = await fetchJSON(`/api/fraud-links-txn?from=${from}&to=${to}&txn_id=${txnId}&neighbors=600`);
    chart.hideLoading();
    chart.setOption(buildGraphOption(graph), true);
  } catch (e) {
    chart.hideLoading();
    chart.clear();
  }
}

async function renderLinks(from, to) {
  const graph = await fetchJSON(`/api/fraud-links?from=${from}&to=${to}&limit=250`);
  const el = document.getElementById('chart-links');
  const chart = echarts.init(el);

  const categories = [
    { name: 'txn' }, { name: 'customer' }, { name: 'card' }, { name: 'device' }, { name: 'email' }
  ];
  const catIndex = (cat) => {
    if (cat === 'txn') return 0;
    if (cat === 'customer') return 1;
    if (cat === 'card') return 2;
    if (cat === 'device') return 3;
    if (cat === 'email') return 4;
    return 0;
  };

  chart.setOption({
    backgroundColor: 'transparent',
    tooltip: { formatter: (p) => p.dataType === 'node' ? p.data.name : '' },
    legend: [{ data: categories.map(c => c.name), textStyle: { color: '#e5e7eb' } }],
    series: [{
      type: 'graph',
      layout: 'force',
      roam: true,
      draggable: true,
      categories,
      force: {
        repulsion: 120,
        edgeLength: 50,
        gravity: 0.05
      },
      label: { show: false },
      emphasis: { focus: 'adjacency' },
      lineStyle: { opacity: 0.35, width: 1 },
      data: graph.nodes.map(n => ({
        name: n.id,
        category: catIndex(n.cat),
        symbolSize: n.cat === 'txn' ? (8 + Math.min(20, n.value * 25)) : 10,
        value: n.value
      })),
      links: graph.edges.map(e => ({ source: e.source, target: e.target }))
    }]
  });

  chart.off('click');
  chart.on('click', params => {
    if (params.dataType !== 'node') return;
    chart.dispatchAction({ type: 'focusNodeAdjacency', seriesIndex: 0, dataIndex: params.dataIndex });
  });
}

async function renderFraud3D(from, to) {
  const points = await fetchJSON(`/api/fraud-cloud-3d?from=${from}&to=${to}`);
  const chart = echarts.init(document.getElementById('chart-fraud-3d'));

  if (points.length === 0) {
    chart.clear();
    return;
  }

  const data = points.map(p => [p.x, p.y, p.z, p.label, p.score]);

  chart.setOption({
    backgroundColor: 'transparent',
    tooltip: {
      formatter: (p) => {
        const [x,y,z,label,score] = p.data;
        return `
          log(amount): ${x.toFixed(2)}<br>
          secs_since_prev_txn: ${y.toFixed(0)}<br>
          cust_txn_cnt_7d: ${z}<br>
          fraud_score: ${score.toFixed(3)}<br>
          fraud: ${label === 1 ? 'Да' : 'Нет'}
        `;
      }
    },
    visualMap: [{
      dimension: 3,
      categories: [0,1],
      inRange: { color: ['#4ade80', '#f97373'] }
    }],
    grid3D: {
      viewControl: {
        autoRotate: false,
        autoRotateSpeed: 8,
        rotateSensitivity: 1.2,
        zoomSensitivity: 1.2
      },
      boxWidth: 200,
      boxDepth: 180,
      boxHeight: 160
    },
    xAxis3D: { name: "log(amount)" },
    yAxis3D: { name: "log(secs_prev_txn)" },
    zAxis3D: { name: "lgo(txn_cnt_7d)" },
    series: [{
      type: 'scatter3D',
      data,
      symbolSize: p => 4 + p[4] * 10,
      itemStyle: { opacity: 0.9 }
    }]
  });
}

async function renderFraud3Dc(from, to) {
  const points = await fetchJSON(`/api/fraud-cloud-3d-cluster?from=${from}&to=${to}`);
  const chart = echarts.init(document.getElementById('chart-fraud-3d-cluster'));

  if (points.length === 0) return chart.clear();

  const data = points.map(p => [p.x, p.y, p.z, p.cluster, p.score, p.label]);

  chart.setOption({
    backgroundColor: 'transparent',
    tooltip: {
      formatter: (p) => {
        const [x,y,z,cluster,score,label] = p.data;
        return `
          log(amount): ${x.toFixed(2)}<br>
          log_secs_prev: ${y.toFixed(2)}<br>
          log_txn_cnt_7d: ${z.toFixed(2)}<br>
          fraud_score: ${score.toFixed(3)}<br>
          fraud_label: ${label}<br>
          cluster: ${cluster}
        `;
      }
    },
    visualMap: [{
      dimension: 3,
      min: 0,
      max: 6,
      calculable: true,
      inRange: { color: ['#3b82f6', '#10b981', '#f97316', '#ef4444', '#a855f7', '#14b8a6', '#eab308'] }
    }],
    grid3D: {
      viewControl: {
        autoRotate: false,
        rotateSensitivity: 1.2,
        zoomSensitivity: 1.2
      }
    },
    xAxis3D: { name: "log(amount)" },
    yAxis3D: { name: "log(secs_prev)" },
    zAxis3D: { name: "log(txn_cnt_7d)" },
    series: [{
      type: 'scatter3D',
      data,
      symbolSize: p => 5 + p[4] * 8,
      itemStyle: { opacity: 0.9 }
    }]
  });
}

async function initDashboard(from, to) {
  const summary = await fetchJSON(`/api/summary?from=${from}&to=${to}`);
  const total = summary.total_tx;
  const flagged = summary.flagged_tx;
  const rate = total ? (flagged * 100 / total).toFixed(2) + '%' : '0%';

  document.getElementById('kpi-total').textContent = total;
  document.getElementById('kpi-flagged').textContent = flagged;
  document.getElementById('kpi-rate').textContent = rate;
  document.getElementById('kpi-avg').textContent = summary.avg_score.toFixed(3);

  const tsData = await fetchJSON(`/api/timeseries?from=${from}&to=${to}`);
  const tsChart = echarts.init(document.getElementById('chart-timeseries'));
  tsChart.setOption({
    backgroundColor: 'transparent',
    tooltip: { trigger: 'axis' },
    legend: { data: ['Всего', 'Флагнуто'], textStyle: { color: '#e5e7eb' } },
    grid: { left: 40, right: 20, top: 40, bottom: 40 },
    xAxis: {
      type: 'category',
      data: tsData.map(d => d.date),
      axisLine: { lineStyle: { color: '#64748b' } }
    },
    yAxis: {
      type: 'value',
      axisLine: { lineStyle: { color: '#64748b' } },
      splitLine: { lineStyle: { color: '#1f2937' } }
    },
    series: [
      { name: 'Всего', type: 'bar', data: tsData.map(d => d.total_tx) },
      { name: 'Флагнуто', type: 'line', data: tsData.map(d => d.flagged_tx), smooth: true }
    ]
  });

  const hist = await fetchJSON(`/api/score-histogram?from=${from}&to=${to}`);
  const histChart = echarts.init(document.getElementById('chart-score-hist'));
  histChart.setOption({
    backgroundColor: 'transparent',
    tooltip: { trigger: 'axis' },
    grid: { left: 40, right: 20, top: 40, bottom: 40 },
    xAxis: {
      type: 'category',
      data: hist.map(d => d.bin),
      axisLine: { lineStyle: { color: '#64748b' } }
    },
    yAxis: {
      type: 'value',
      axisLine: { lineStyle: { color: '#64748b' } },
      splitLine: { lineStyle: { color: '#1f2937' } }
    },
    series: [{ type: 'bar', data: hist.map(d => d.cnt) }]
  });

  const byChannel = await fetchJSON(`/api/by-channel?from=${from}&to=${to}`);
  const chanChart = echarts.init(document.getElementById('chart-by-channel'));
  chanChart.setOption({
    backgroundColor: 'transparent',
    tooltip: { trigger: 'axis' },
    legend: { data: ['Всего', 'Флагнуто'], textStyle: { color: '#e5e7eb' } },
    grid: { left: 40, right: 20, top: 40, bottom: 40 },
    xAxis: {
      type: 'category',
      data: byChannel.map(d => d.channel),
      axisLine: { lineStyle: { color: '#64748b' } }
    },
    yAxis: {
      type: 'value',
      axisLine: { lineStyle: { color: '#64748b' } },
      splitLine: { lineStyle: { color: '#1f2937' } }
    },
    series: [
      { name: 'Всего', type: 'bar', data: byChannel.map(d => d.total_tx) },
      { name: 'Флагнуто', type: 'bar', data: byChannel.map(d => d.flagged_tx) }
    ]
  });

  const top = await fetchJSON(`/api/top-transactions?from=${from}&to=${to}`);
  const tbody = document.getElementById('top-body');
  tbody.innerHTML = top.map(row => `
    <tr>
      <td>${row.event_date}</td>
      <td>${row.transaction_id}</td>
      <td>${row.customer_id}</td>
      <td>${(row.amount ?? 0).toFixed(2)}</td>
      <td>${row.country || ''}</td>
      <td>${row.channel || ''}</td>
      <td>${row.fraud_score.toFixed(3)}</td>
    </tr>
  `).join('');

  const firstTxn = await loadFraudTxnList(from, to);
  const refreshBtn = document.getElementById('refresh-fraud-list');
  refreshBtn.onclick = async () => {
    const first = await loadFraudTxnList(from, to);
    if (first) await renderTxnLinks(from, to, first);
  };
  if (firstTxn) await renderTxnLinks(from, to, firstTxn);

  await renderLinks(from, to);
  await renderFraud3Dc(from, to);
  await renderFraud3D(from, to);
}

async function init() {
  const range = await fetchJSON('/api/date-range');
  const fromInput = document.getElementById('from-date');
  const toInput = document.getElementById('to-date');

  fromInput.value = range.from;
  toInput.value = range.to;

  document.getElementById('apply-range').onclick = () => {
    const from = fromInput.value;
    const to = toInput.value;
    initDashboard(from, to).catch(console.error);
  };

  await initDashboard(range.from, range.to);
}

init().catch(console.error);
</script>
</body>
</html>